<p>Wecome to Meadowlark Travel!  Please <a href="/newsletter">sign up for our newsletter</a>!</p>

<p>Also, please enter our Vacation Photo Contest using either:</p>
<ul>
  <li><a href="/contest/vacation-photo-ajax">Submission</a>.</li>
</ul>
<ul>
  <li><a href="/">Home</a></li>
  <li><a href="/about">About</a></li>
</ul>

   
<h2>Your Shopping Cart</h2>
<ul>
  {{#each cart.errors}}
    <div class="alert alert-dismissible alert-danger">
      <button type="button" class="close" 
        data-dismiss="alert" aria-hidden="true">&times;</button>
      <strong>Error!</strong> {{.}}
    </div>
  {{/each}}
  {{#each cart.warnings}}
    <div class="alert alert-dismissible alert-warning">
      <button type="button" class="close" 
        data-dismiss="alert" aria-hidden="true">&times;</button>
      <strong>Warning!</strong> {{.}}
    </div>
  {{/each}}
  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th class="text-right">Price</th>
        <th class="text-right">Guests</th>
      </tr>
    </thead>
    <tbody>
      {{#each cart.items}}
        <tr>
          <td>{{product.name}}</td>
          <td class="text-right">{{product.price}}</td>
          <td class="text-right">{{guests}}</td>
        </tr>
      {{/each}}
    </tbody>
  </table>
</ul>

<h2>Store</h2>
<p><i>To remove items, use negative numbers (in real life we would never design a UI like this!)</i></p>
<form action="/add-to-cart" method="POST">
  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th class="text-right">Price</th>
        <th class="text-right">Guests</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {{#each products}}
        <tr>
          <td>{{name}}</td>
          <td class="text-right">{{price}}</td>
          <td class="text-right"><input type="number" value="0" name="guests-{{id}}" /></td>
        </tr>
      {{/each}}
    </tbody>
  </table>
  <button type="submit" class="btn btn-primary">Add To Cart</button>
</ul>

{{> weather}}
<h2>Tell Us About Yourself</h2>
<form action="/process-contact" method="post">
  <div>
    <label>Your name:
      <input name="name" />
    </label>
  </div>
  <br />
  <div>
    <label>Your email:
      <input name="email" type="email" />
    </label>
  </div>
  <br />
  <div>
    <label>Simulator error:
      <input type="checkbox" name="simulateError" />
    </label>
  </div>
  <br />
  <div>
    <label>Use Ajax?:
      <input type="checkbox" name="useAjax" />
    </label>
  </div>
  <br />
  <div>
    <button type="submit">Submit</button>
  </div>
</form>
<script>
  // little utility object for calling our API
  const api = {
    post(path, data) {
      const body = typeof data === 'object' ? JSON.stringify(data) : data
      const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      }
      return fetch(path, { method: "POST", body, headers })
        .then(res => {
          if(res.status < 200 || res.status >= 400)
            return Promise.reject(new Error(`API error: ${res.status}`))
          return res.json()
        })
    }
  }
  // intercept form submission
  document.querySelector('form').addEventListener('submit', evt => {
    const formdata = new FormData(evt.target)
    if(!formdata.get('useAjax')) return   // if not using ajax, proceed with normal form submission
    // abort normal form submission and use ajax
    evt.preventDefault()
    const data = {
      name: formdata.get('name'),
      email: formdata.get('email'),
      simulateError: formdata.get('simulateError'),
    }
    // we're just redirecting to the existing "thank you" and "error" pages, but
    // in a real application, we would probably dynamically change the DOM to
    // indicate success or failure
    api.post('/process-contact', data)
      .then(() => window.location = '/thank-you')
      .catch(() => window.location = '/contact-error')
  })
</script>